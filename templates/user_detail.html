{% extends 'base.html' %}
{% block content %}

  <h3>Welcome, {{user.name}}!</h3> 

 <h2>Your Hike List</h2>


 <div class='hike-div'>
    {% if user.usertrails|length == 0 %}
    <h4>No Hikes yet.</h4>
    <h4><a href="/search">Plan your Hikes</a>
    {% else %}
      
        <div class="container-fluid">
            <table class="table table-hover">
                <tr>
                    <th>Trail Name</th>
                    <th>Trail URL</th> 
                    <th>Trail Length (miles) </th>
                    <th>Date</th>
                    <th>Comments</th>
                    <th>Your Rating</th>
                    <th>Overall Rating</th>
                    <th>Recommend</th>
                </tr>
                
                {% for usertrail in user.usertrails %}
                <tr>
                     {% for hike in usertrail.hikes %}
                        <input id="hike-comment" data-hike-id="{{ hike.hike_id }}" hidden>
                     {% endfor %}


                    <td>{{usertrail.trail.name}}</td>
                    <td><a href= "">{{usertrail.trail.url}}</a></td>
                    <td>{{usertrail.trail.length}}</td>
                    <td>{% for hike in usertrail.hikes %}
                            {{hike.date.strftime('%Y-%m-%d')}}
                        {% endfor %}</td>
                    <td id="td-{{ usertrail.trail.trail_id }}">

                        {% for hike in usertrail.hikes %}
                            {% if not hike.comments %}
                            <span class="comment-span">
                            <input type="text" name="comments" placeholder="add your comments here" id="comments-{{ usertrail.trail.trail_id }}">
                            <button class="comment-it" data-trail-id="{{ usertrail.trail.trail_id }}" data-hike-id="{{ hike.hike_id }}" >Add</button>
                            </span><br>

                        {% else %}
                            {% for hike in usertrail.hikes %}
                                <span class="comment-span"> 
                                  <span>{{hike.comments}}</span> 
                                <!-- <input id="get-edit-comment" value="{{hike.comments}}" hidden>-->
                                  <button class="edit-it" data-trail-id="{{ usertrail.trail.trail_id }}" data-hike-id="{{ hike.hike_id }}">Edit</button>
                                </span>
                            {% endfor %}    
                        {% endif %}</td>
                        {% endfor %}

                    <td>{% for hike in usertrail.hikes %}
                            {% if not hike.u_rating%}
                                 <span class="rating-span">
                                 <input type="number" name="your-rating" step="0.5" min="1" max="5" data-hike-id="{{ hike.hike_id }}">
                                 <button class="rate-it" data-trail-id="{{ usertrail.trail.trail_id }}" data-hike-id="{{ hike.hike_id }}" > Rate </button>
                                 </span>
                            {% else %}
                                {% for hike in usertrail.hikes %}
                                    <span class="final rating"> {{hike.u_rating}} 
                                {% endfor %}
                            {% endif %}

                        {% endfor%} </td>

                    <td>{{ usertrail.rating }}</td>

                    <td>
                      <button type="button" class="btn btn-primary btn-sm rec-button"  data-trail-name="{{ usertrail.trail.name }}" data-target="#myModal" >Recommend
                      </button>
                    </td>

                </tr>
                {% endfor %}
                
            </table>
    </div>
      
    {% endif %}
 </div>


 <!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">Recommend Trail</h4>
      </div>
      <div class="modal-body">
        <form>
          <div class="form-group">
            <label for="recipient-name" class="control-label">Recipient Email:</label>
            <input type="text" class="form-control" id="recipient-email">
          </div>
          <input type="text" id="hidden-trail-name" hidden>
          <div class="form-group">
            <label for="message-text" class="control-label">Message:</label>
            <textarea class="form-control" id="message-text"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" onclick="sendFunction(this)" class="btn btn-primary" data-dismiss="modal">Send</button>
      </div>
    </div>
  </div>
</div>


<!-- <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script> -->
<script>
  "use strict";


  function sendFunction(element) {
    
    console.log("hi modal");
    var re_email = $(element).parent().prev().find("#recipient-email").val();
    var message = $(element).parent().prev().find("#message-text").val();
    var trailName = $(element).parent().prev().find('#hidden-trail-name').val();
    var se_email = "{{ user.email }}";

    console.log(message);

    var formInputs = {
        "trail_name": trailName,
        "message": message,
        "re_email": re_email,
        "se_email": se_email
    }
    
    $.post("/send-email",formInputs) 

    
    /*$(element).parent().prev().find("#message-text").val('');
    $(element).parent().prev().find("#recipient-email").val('');*/
}

$('.rec-button').on('click', function (evt) {
      console.log('show');
      var trailId = $(this).data('trail-name');
      $('#hidden-trail-name').val(trailId);
      console.log(trailId);
      $('#myModal').modal();
})

  /* Add Comments  */
  function showInfo(results){

    console.log("hi")
  }

  function getInfo(evt){
    evt.preventDefault();

    let inputId = $(this).data("trailId");
    let comments = $(this).prev().val();
    let hikeId = $(this).data("hike-id");

    console.log(comments);

    var formInputs = {
        "trail_id": inputId,
        "comments": comments,
        "hike_id": hikeId
    }
    
    $.post("/add-trails-comment",formInputs, showInfo);

    $(this).attr("class", "edit-it")
    $(this).html("Edit")
    $(this).prev().remove()    
    $(this).before("<span>" +comments+ "</span>")

  }


  /*$(".comment-it").on('click', getInfo);*/
 $(document).on('click', ".comment-it", getInfo)

   /* Now Edit Comments  */
  function showComment(results){
    console.log("hi")
    
  }

  function getComment(evt){
    evt.preventDefault();

    var old_comments = $(this).prev().text();
    console.log($(this).prev());
    // debugger;
    $(this).prev().remove();
    $(this).before("<input type='text'>");
    $(this).prev().val(old_comments);
    $(this).attr("class", "comment-it");
    $(this).html("Add");
    var comments = $(this).prev().val()
    console.log(comments)
    let hikeId = $(this).data("hikeId");
    
    var formInputs = {
        "trail_id": $(this).data('trail-id'),
        "comments": comments,
        "hike_id": hikeId
    }


    $.post("/add-trails-comment",formInputs, showComment);


  }

  $(document).on('click', ".edit-it", getComment)


 /* Add Rating */

 function showRating(results){
    console.log("rating print")
 }

 function getRating(evt){
    evt.preventDefault();

    let rating = $(this).prev().val()
    let hikeId = $(this).data("hike-id");

    console.log(rating)

    var formInputs = {
        "u_rating":rating,
        "hike_id": hikeId
    }

    $.post("/add-rating", formInputs, showRating);

    $(this).prev().remove()    
    $(this).before("<span>" +rating+ "</span>")
    $(this).hide();
    $(".rate-it").hide();

 }

 $(".rate-it").on('click', getRating)




</script>

 <script src=
  "https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.2.1/Chart.js">
    </script>
    <canvas id="bar-chart" width="800" height="250"></canvas> 

 <script>
    "use strict";
    // Bar chart
    new Chart(document.getElementById("bar-chart"), {
    type: 'bar',
    data: {
      labels: ["January", "February", "March", "April", "May", "June"],
      datasets: [
        {
          label: "number of hikes",
          backgroundColor: ["#3e95cd", "#8e5ea2","#3cba9f","#e8c3b9","#c45850"],
          data: {{ hike_num_list }}
        },
        {
          label: "total miles hiked",
          backgroundColor: ["#3e95cd", "#8e5ea2","#3cba9f","#e8c3b9","#c45850"],
          data: {{ hike_len_list }}
        }
      ]
    },
    options: {
      legend: { display: false },
      title: {
        display: true,
        text: 'Number of hikes in each month'
      }
    }
});

</script>  


{% endblock %}

